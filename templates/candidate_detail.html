{% extends "base.html" %}

{% block title %}Candidate Details - Alfa Operations Platform{% endblock %}

{% block nav_candidates %}bg-gray-700{% endblock %}

{% block page_title %}Candidate Profile{% endblock %}
{% block page_subtitle %}View and manage candidate information{% endblock %}

{% block content %}
<div x-data="candidateDetailApp()" x-init="init()">

    <!-- Loading State -->
    <div x-show="loading" class="flex items-center justify-center h-64">
        <div class="spinner"></div>
    </div>

    <!-- Error State -->
    <div x-show="!loading && error" x-cloak class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
        <svg class="w-12 h-12 mx-auto text-red-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h3 class="text-lg font-medium text-red-800" x-text="error"></h3>
        <a href="/candidates" class="mt-4 inline-flex items-center text-red-600 hover:text-red-800">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Candidates
        </a>
    </div>

    <!-- Content -->
    <div x-show="!loading && !error && candidate" x-cloak>

        <!-- Back Link & Actions -->
        <div class="flex items-center justify-between mb-6">
            <a href="/candidates" class="flex items-center text-gray-600 hover:text-alfa-blue">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Pipeline
            </a>
            <div class="flex items-center gap-3">
                <a
                    :href="candidate?.zoho_url"
                    target="_blank"
                    class="flex items-center gap-2 px-4 py-2 border rounded-lg hover:bg-gray-50 text-gray-700"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                    View in Zoho
                </a>
            </div>
        </div>

        <!-- Header Card -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-wrap items-start justify-between gap-4">
                <!-- Candidate Info -->
                <div class="flex items-start gap-4">
                    <div class="w-16 h-16 bg-alfa-blue rounded-full flex items-center justify-center text-white text-2xl font-semibold">
                        <span x-text="candidate.full_name?.charAt(0)?.toUpperCase()"></span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800" x-text="candidate.full_name"></h2>
                        <p class="text-gray-500" x-text="candidate.email || 'No email'"></p>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <!-- Stage Badge -->
                            <span
                                class="px-3 py-1 text-sm font-medium rounded-full"
                                :class="getStageBadgeColor(candidate.stage)"
                                x-text="candidate.stage"
                            ></span>
                            <!-- Tier Badge -->
                            <span
                                x-show="candidate.tier"
                                class="px-2 py-1 text-xs font-medium rounded-full"
                                :class="{
                                    'bg-green-100 text-green-700': candidate.tier === 'Tier 1',
                                    'bg-blue-100 text-blue-700': candidate.tier === 'Tier 2',
                                    'bg-purple-100 text-purple-700': candidate.tier === 'Tier 3'
                                }"
                                x-text="candidate.tier"
                            ></span>
                            <!-- Status Flags -->
                            <span x-show="candidate.is_unresponsive" class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded-full">Unresponsive</span>
                            <span x-show="candidate.has_pending_documents" class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full">Pending Docs</span>
                            <span x-show="candidate.needs_training" class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded-full">Needs Training</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="flex gap-6 text-center">
                    <div class="bg-gray-50 rounded-lg px-4 py-2">
                        <p class="text-2xl font-bold text-alfa-blue" x-text="candidate.days_in_stage || 0"></p>
                        <p class="text-xs text-gray-500">Days in Stage</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg px-4 py-2">
                        <p class="text-2xl font-bold text-gray-700" x-text="candidate.interviews?.length || 0"></p>
                        <p class="text-xs text-gray-500">Interviews</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg px-4 py-2">
                        <p class="text-2xl font-bold text-gray-700" x-text="candidate.tasks?.length || 0"></p>
                        <p class="text-xs text-gray-500">Tasks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <!-- Tab Headers -->
            <div class="border-b flex">
                <button
                    @click="activeTab = 'profile'"
                    :class="activeTab === 'profile' ? 'border-b-2 border-alfa-blue text-alfa-blue' : 'text-gray-500 hover:text-gray-700'"
                    class="px-6 py-4 font-medium transition-colors"
                >
                    Profile
                </button>
                <button
                    @click="activeTab = 'activity'"
                    :class="activeTab === 'activity' ? 'border-b-2 border-alfa-blue text-alfa-blue' : 'text-gray-500 hover:text-gray-700'"
                    class="px-6 py-4 font-medium transition-colors"
                >
                    Activity
                </button>
                <button
                    @click="activeTab = 'notes'"
                    :class="activeTab === 'notes' ? 'border-b-2 border-alfa-blue text-alfa-blue' : 'text-gray-500 hover:text-gray-700'"
                    class="px-6 py-4 font-medium transition-colors"
                >
                    Notes
                    <span x-show="(candidate.notes?.length || 0) + (candidate.crm_notes?.length || 0) > 0" class="ml-1 bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full" x-text="(candidate.notes?.length || 0) + (candidate.crm_notes?.length || 0)"></span>
                </button>
                <button
                    @click="activeTab = 'emails'; if (!emailsLoaded) loadEmails();"
                    :class="activeTab === 'emails' ? 'border-b-2 border-alfa-blue text-alfa-blue' : 'text-gray-500 hover:text-gray-700'"
                    class="px-6 py-4 font-medium transition-colors"
                >
                    Emails
                    <span x-show="emailsData.total_count > 0" class="ml-1 bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full" x-text="emailsData.total_count"></span>
                </button>
                <button
                    @click="activeTab = 'documents'"
                    :class="activeTab === 'documents' ? 'border-b-2 border-alfa-blue text-alfa-blue' : 'text-gray-500 hover:text-gray-700'"
                    class="px-6 py-4 font-medium transition-colors"
                >
                    Documents
                </button>
            </div>

            <!-- Tab Content -->
            <div class="p-6">

                <!-- Profile Tab -->
                <div x-show="activeTab === 'profile'" x-cloak>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                        <!-- Contact Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                Contact Information
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Email</span>
                                    <span class="text-gray-800" x-text="candidate.email || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Phone</span>
                                    <span class="text-gray-800" x-text="candidate.phone || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Mobile</span>
                                    <span class="text-gray-800" x-text="candidate.mobile || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">WhatsApp</span>
                                    <span class="text-gray-800" x-text="candidate.whatsapp_number || '-'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Location -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Location
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">City</span>
                                    <span class="text-gray-800" x-text="candidate.city || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">State</span>
                                    <span class="text-gray-800" x-text="candidate.state || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Country</span>
                                    <span class="text-gray-800" x-text="candidate.country || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Service Location</span>
                                    <span class="text-gray-800" x-text="candidate.service_location || '-'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Languages -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                                </svg>
                                Languages
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Primary</span>
                                    <span class="text-gray-800" x-text="candidate.language || '-'"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500 block mb-1">All Languages</span>
                                    <div class="flex flex-wrap gap-1">
                                        <template x-for="lang in (candidate.languages || '').split(';').filter(l => l.trim())" :key="lang">
                                            <span class="px-2 py-0.5 bg-gray-200 text-gray-700 text-xs rounded" x-text="lang.trim()"></span>
                                        </template>
                                        <span x-show="!candidate.languages" class="text-gray-400">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assignment -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Assignment
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Candidate Owner</span>
                                    <span class="text-gray-800" x-text="candidate.candidate_owner || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Recruitment Owner</span>
                                    <span class="text-gray-800" x-text="candidate.recruitment_owner || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Assigned Client</span>
                                    <span class="text-gray-800" x-text="candidate.assigned_client || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Agreed Rate</span>
                                    <span class="text-gray-800" x-text="candidate.agreed_rate || '-'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Assessment Status -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Assessment Status
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Language Assessment</span>
                                    <span :class="candidate.language_assessment_passed ? 'text-green-600' : 'text-gray-400'" x-text="candidate.language_assessment_passed ? 'Passed' : 'Pending'"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Background Check</span>
                                    <span :class="candidate.bgv_passed ? 'text-green-600' : 'text-gray-400'" x-text="candidate.bgv_passed ? 'Passed' : 'Pending'"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">System Specs</span>
                                    <span :class="candidate.system_specs_approved ? 'text-green-600' : 'text-gray-400'" x-text="candidate.system_specs_approved ? 'Approved' : 'Pending'"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Offer Accepted</span>
                                    <span :class="candidate.offer_accepted ? 'text-green-600' : 'text-gray-400'" x-text="candidate.offer_accepted ? 'Yes' : 'No'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Training -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                                Training
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Training Accepted</span>
                                    <span :class="candidate.training_accepted ? 'text-green-600' : 'text-gray-400'" x-text="candidate.training_accepted ? 'Yes' : 'No'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Training Status</span>
                                    <span class="text-gray-800" x-text="candidate.training_status || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Start Date</span>
                                    <span class="text-gray-800" x-text="formatDate(candidate.training_start_date) || '-'"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Alfa One Onboarded</span>
                                    <span :class="candidate.alfa_one_onboarded ? 'text-green-600' : 'text-gray-400'" x-text="candidate.alfa_one_onboarded ? 'Yes' : 'No'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Key Dates
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Created in Zoho</span>
                                    <span class="text-gray-800" x-text="formatDate(candidate.zoho_created_time) || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Last Activity</span>
                                    <span class="text-gray-800" x-text="formatDate(candidate.last_activity_date) || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Last Communication</span>
                                    <span class="text-gray-800" x-text="formatDate(candidate.last_communication_date) || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Next Follow-up</span>
                                    <span class="text-gray-800" x-text="formatDate(candidate.next_followup) || '-'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Source -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Source Info
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Source</span>
                                    <span class="text-gray-800" x-text="candidate.candidate_source || '-'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Zoho ID</span>
                                    <span class="text-gray-800 font-mono text-xs" x-text="candidate.zoho_id"></span>
                                </div>
                                <div x-show="candidate.disqualification_reason">
                                    <span class="text-gray-500 block mb-1">Disqualification Reason</span>
                                    <span class="text-red-600" x-text="candidate.disqualification_reason"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Move Stage -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                </svg>
                                Move Stage
                            </h3>
                            <select
                                x-model="newStage"
                                class="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alfa-blue"
                            >
                                <option value="">Select new stage...</option>
                                <option value="New Candidate">New Candidate</option>
                                <option value="Screening">Screening</option>
                                <option value="Interview Scheduled">Interview Scheduled</option>
                                <option value="Interview Completed">Interview Completed</option>
                                <option value="Assessment">Assessment</option>
                                <option value="Onboarding">Onboarding</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                            <button
                                @click="moveStage()"
                                :disabled="!newStage || newStage === candidate.stage"
                                class="mt-2 w-full px-4 py-2 bg-alfa-blue text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                            >
                                Update Stage
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div x-show="activeTab === 'activity'" x-cloak>
                    <div class="space-y-4">
                        <!-- Interviews -->
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3">Interviews</h3>
                            <div x-show="candidate.interviews?.length === 0" class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg">
                                No interviews scheduled
                            </div>
                            <div class="space-y-3">
                                <template x-for="interview in candidate.interviews" :key="interview.id">
                                    <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                                        <div>
                                            <p class="font-medium text-gray-800" x-text="interview.interview_type"></p>
                                            <p class="text-sm text-gray-500" x-text="formatDateTime(interview.scheduled_date)"></p>
                                            <p class="text-xs text-gray-400" x-text="'Interviewer: ' + (interview.interviewer || 'TBD')"></p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="px-2 py-1 text-xs rounded-full"
                                                :class="{
                                                    'bg-blue-100 text-blue-700': interview.status === 'scheduled',
                                                    'bg-green-100 text-green-700': interview.status === 'completed',
                                                    'bg-red-100 text-red-700': interview.status === 'no_show',
                                                    'bg-gray-100 text-gray-700': interview.status === 'cancelled'
                                                }"
                                                x-text="interview.status"
                                            ></span>
                                            <span x-show="interview.outcome" class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded-full" x-text="interview.outcome"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Tasks -->
                        <div class="mt-6">
                            <h3 class="font-semibold text-gray-800 mb-3">Tasks</h3>
                            <div x-show="candidate.tasks?.length === 0" class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg">
                                No tasks assigned
                            </div>
                            <div class="space-y-3">
                                <template x-for="task in candidate.tasks" :key="task.id">
                                    <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                                        <div>
                                            <p class="font-medium text-gray-800" x-text="task.title"></p>
                                            <p class="text-sm text-gray-500" x-text="task.description || 'No description'"></p>
                                            <p class="text-xs text-gray-400">
                                                <span x-text="'Due: ' + (formatDate(task.due_date) || 'No due date')"></span>
                                                <span x-show="task.assigned_to" x-text="' | Assigned to: ' + task.assigned_to"></span>
                                            </p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="px-2 py-1 text-xs rounded-full"
                                                :class="{
                                                    'bg-yellow-100 text-yellow-700': task.status === 'pending',
                                                    'bg-blue-100 text-blue-700': task.status === 'in_progress',
                                                    'bg-green-100 text-green-700': task.status === 'completed',
                                                    'bg-gray-100 text-gray-700': task.status === 'cancelled'
                                                }"
                                                x-text="task.status"
                                            ></span>
                                            <span
                                                class="px-2 py-1 text-xs rounded-full"
                                                :class="{
                                                    'bg-red-100 text-red-700': task.priority === 'high',
                                                    'bg-yellow-100 text-yellow-700': task.priority === 'medium',
                                                    'bg-gray-100 text-gray-700': task.priority === 'low'
                                                }"
                                                x-text="task.priority"
                                            ></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Tab -->
                <div x-show="activeTab === 'notes'" x-cloak>
                    <!-- Add Note Form -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Add Note</h3>
                        <textarea
                            x-model="newNote.content"
                            rows="3"
                            placeholder="Enter your note here..."
                            class="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alfa-blue resize-none"
                        ></textarea>
                        <div class="flex items-center justify-between mt-3">
                            <select x-model="newNote.type" class="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alfa-blue">
                                <option value="general">General</option>
                                <option value="interview">Interview</option>
                                <option value="assessment">Assessment</option>
                                <option value="follow_up">Follow-up</option>
                                <option value="document">Document</option>
                            </select>
                            <button
                                @click="addNote()"
                                :disabled="!newNote.content.trim()"
                                class="px-4 py-2 bg-alfa-blue text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                            >
                                Add Note
                            </button>
                        </div>
                    </div>

                    <!-- Platform Notes List -->
                    <div x-show="candidate.notes?.length > 0" class="mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Platform Notes</h3>
                        <div class="space-y-4">
                            <template x-for="note in candidate.notes" :key="note.id">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="px-2 py-0.5 text-xs rounded-full"
                                                :class="{
                                                    'bg-gray-200 text-gray-700': note.note_type === 'general',
                                                    'bg-blue-100 text-blue-700': note.note_type === 'interview',
                                                    'bg-purple-100 text-purple-700': note.note_type === 'assessment',
                                                    'bg-yellow-100 text-yellow-700': note.note_type === 'follow_up',
                                                    'bg-green-100 text-green-700': note.note_type === 'document'
                                                }"
                                                x-text="note.note_type"
                                            ></span>
                                            <span class="text-xs text-gray-500" x-text="formatDateTime(note.created_at)"></span>
                                            <span x-show="note.created_by" class="text-xs text-gray-400" x-text="'by ' + note.created_by"></span>
                                        </div>
                                        <button
                                            @click="deleteNote(note.id)"
                                            class="p-1 text-gray-400 hover:text-red-500"
                                            title="Delete note"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-gray-800 whitespace-pre-wrap" x-text="note.content"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- CRM Notes (synced from Zoho) - Combined Summary View -->
                    <div x-show="candidate.crm_notes?.length > 0">
                        <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-400">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">CRM Notes</span>
                                    <span class="text-sm text-gray-600" x-text="candidate.crm_notes?.length + ' note' + (candidate.crm_notes?.length !== 1 ? 's' : '')"></span>
                                </div>
                                <span class="text-xs text-gray-500" x-text="'Latest: ' + formatDateTime(candidate.crm_notes?.[0]?.zoho_created_time)"></span>
                            </div>

                            <!-- Combined Summary of all notes -->
                            <div class="text-gray-800 mb-3">
                                <p x-text="getCrmNotesSummary()"></p>
                            </div>

                            <!-- Key Phrases (aggregated from all notes) -->
                            <div x-show="getAllKeyPhrases().length > 0" class="flex flex-wrap gap-1 mb-3">
                                <template x-for="phrase in getAllKeyPhrases().slice(0, 8)" :key="phrase">
                                    <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700" x-text="phrase"></span>
                                </template>
                                <span x-show="getAllKeyPhrases().length > 8" class="px-2 py-0.5 text-xs text-gray-500" x-text="'+' + (getAllKeyPhrases().length - 8) + ' more'"></span>
                            </div>

                            <!-- Expandable detailed notes (newest first) -->
                            <details class="mt-2">
                                <summary class="text-sm text-blue-600 cursor-pointer hover:text-blue-800 font-medium">
                                    View all notes
                                </summary>
                                <div class="mt-3 space-y-3 max-h-96 overflow-y-auto">
                                    <template x-for="note in candidate.crm_notes" :key="note.id">
                                        <div class="bg-white rounded p-3 border border-gray-200">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span x-show="note.title" class="text-sm font-medium text-gray-700" x-text="note.title"></span>
                                                <span class="text-xs text-gray-500" x-text="formatDateTime(note.zoho_created_time)"></span>
                                                <span x-show="note.created_by" class="text-xs text-gray-400" x-text="'by ' + note.created_by"></span>
                                            </div>
                                            <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="note.raw_content"></p>
                                        </div>
                                    </template>
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="candidate.notes?.length === 0 && candidate.crm_notes?.length === 0" class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg">
                        No notes yet. Add one above.
                    </div>
                </div>

                <!-- Emails Tab -->
                <div x-show="activeTab === 'emails'" x-cloak>
                    <!-- Loading State -->
                    <div x-show="emailsLoading" class="flex items-center justify-center py-12">
                        <div class="spinner"></div>
                        <span class="ml-3 text-gray-500">Loading emails...</span>
                    </div>

                    <!-- Email Content (when loaded) -->
                    <div x-show="!emailsLoading">

                        <!-- Filter Row -->
                        <div class="flex flex-wrap items-center gap-2 mb-4">
                            <!-- Type Filters -->
                            <button
                                @click="emailFilter = 'received'"
                                :class="emailFilter === 'received' ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'"
                                class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                                Received
                                <span :class="emailFilter === 'received' ? 'bg-blue-500' : 'bg-gray-100'" class="ml-1 px-2 py-0.5 rounded-full text-xs" x-text="emailsData.emails?.filter(e => e.direction === 'inbound').length || 0"></span>
                            </button>

                            <button
                                @click="emailFilter = 'sent'"
                                :class="emailFilter === 'sent' ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'"
                                class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                Sent
                                <span :class="emailFilter === 'sent' ? 'bg-blue-500' : 'bg-gray-100'" class="ml-1 px-2 py-0.5 rounded-full text-xs" x-text="emailsData.emails?.filter(e => e.direction === 'outbound').length || 0"></span>
                            </button>

                            <button
                                @click="emailFilter = 'all'"
                                :class="emailFilter === 'all' ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'"
                                class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                                All
                            </button>

                            <!-- Compose & Refresh Buttons -->
                            <div class="ml-auto flex items-center gap-2">
                                <button
                                    @click="openComposeModal()"
                                    class="flex items-center gap-2 px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-all font-medium"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                    Compose
                                </button>
                                <button
                                    @click="loadEmails(true)"
                                    :disabled="emailsLoading"
                                    class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 border border-gray-200 rounded-lg transition-all"
                                >
                                    <svg class="w-4 h-4" :class="emailsLoading ? 'animate-spin' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- AI Insight Banner (if needs follow-up) -->
                        <div x-show="emailThread.needs_followup" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-amber-800">Follow-up needed</p>
                                    <p class="text-sm text-amber-700" x-text="'Candidate replied ' + emailThread.days_since_last_response + ' days ago with no response from team.'"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Email List -->
                        <div x-show="filteredEmails.length > 0" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="divide-y divide-gray-100">
                                <template x-for="email in filteredEmails" :key="email.id">
                                    <div
                                        @click="openEmailModal(email)"
                                        class="p-4 cursor-pointer transition-all hover:bg-gray-50"
                                    >
                                        <div class="flex items-center gap-4">
                                            <!-- Type Indicator -->
                                            <div
                                                :class="email.direction === 'inbound' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'"
                                                class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                                            >
                                                <svg x-show="email.direction === 'inbound'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                                                <svg x-show="email.direction === 'outbound'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                            </div>

                                            <!-- Email Content -->
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-medium text-gray-700 truncate" x-text="email.direction === 'inbound' ? (email.from_address || 'Unknown') : (email.to_address || 'Unknown')"></span>
                                                    <!-- Attachment indicator -->
                                                    <span x-show="email.has_attachment" class="text-gray-400" title="Has attachment">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                                        </svg>
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-600 truncate" x-text="email.subject || '(No subject)'"></p>
                                                <p class="text-xs text-gray-400 truncate mt-0.5" x-text="stripHtml(email.body_snippet)"></p>
                                            </div>

                                            <!-- Date & Arrow -->
                                            <div class="flex items-center gap-2 text-gray-400 flex-shrink-0">
                                                <span class="text-xs" x-text="formatEmailDate(email.sent_at)"></span>
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div x-show="emailsData.emails?.length === 0" class="text-gray-500 text-center py-12 bg-white rounded-xl border border-gray-200">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-lg font-medium">No emails found</p>
                            <p class="text-sm mt-1">Email history will appear here once synced</p>
                            <button
                                @click="loadEmails(true)"
                                class="mt-4 px-4 py-2 bg-alfa-blue text-white rounded-lg hover:bg-blue-700 text-sm"
                            >
                                Fetch email history
                            </button>
                        </div>

                        <!-- No Results for Filter -->
                        <div x-show="emailsData.emails?.length > 0 && filteredEmails.length === 0" class="text-gray-500 text-center py-8 bg-white rounded-xl border border-gray-200">
                            <svg class="w-10 h-10 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <p>No <span x-text="emailFilter"></span> emails to display</p>
                        </div>

                        <!-- Load More & Stats -->
                        <div x-show="emailsData.emails?.length > 0" class="mt-4 flex items-center justify-between">
                            <div class="text-xs text-gray-400">
                                <span x-text="'Showing ' + filteredEmails.length + ' of ' + emailsData.total_count + ' emails'"></span>
                            </div>
                            <button
                                x-show="emailsData.has_more"
                                @click="loadOlderEmails()"
                                :disabled="loadingOlderEmails"
                                class="px-4 py-2 text-sm text-alfa-blue border border-alfa-blue rounded-lg hover:bg-blue-50 disabled:opacity-50"
                            >
                                <span x-show="!loadingOlderEmails">Load more</span>
                                <span x-show="loadingOlderEmails">Loading...</span>
                            </button>
                        </div>
                    </div>

                    <!-- Email Detail Modal -->
                    <div
                        x-show="emailModalOpen"
                        x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0"
                        x-transition:enter-end="opacity-100"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                        class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50"
                        @click="closeEmailModal()"
                    >
                        <div
                            x-show="emailModalOpen"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            @click.stop
                            class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col"
                        >
                            <!-- Modal Header -->
                            <div class="flex items-center justify-between p-4 border-b border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div
                                        :class="selectedEmail?.direction === 'inbound' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'"
                                        class="w-10 h-10 rounded-full flex items-center justify-center"
                                    >
                                        <svg x-show="selectedEmail?.direction === 'inbound'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                                        <svg x-show="selectedEmail?.direction === 'outbound'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800" x-text="selectedEmail?.direction === 'inbound' ? (selectedEmail?.from_address || 'Unknown') : (selectedEmail?.to_address || 'Unknown')"></p>
                                        <p class="text-sm text-gray-500" x-text="selectedEmail?.direction === 'inbound' ? 'Received' : 'Sent'"></p>
                                    </div>
                                </div>
                                <button
                                    @click="closeEmailModal()"
                                    class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                >
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>

                            <!-- Email Content -->
                            <div class="flex-1 overflow-y-auto p-6">
                                <div class="flex items-center gap-2 text-sm text-gray-400 mb-4">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    <span x-text="selectedEmail?.sent_at ? new Date(selectedEmail.sent_at).toLocaleString() : ''"></span>
                                </div>
                                <h2 class="text-xl font-semibold text-gray-800 mb-4" x-text="selectedEmail?.subject || '(No subject)'"></h2>

                                <!-- Email metadata -->
                                <div class="text-sm text-gray-500 space-y-1 mb-4 p-3 bg-gray-50 rounded-lg">
                                    <p><span class="font-medium">From:</span> <span x-text="selectedEmail?.from_address"></span></p>
                                    <p><span class="font-medium">To:</span> <span x-text="selectedEmail?.to_address"></span></p>
                                    <p x-show="selectedEmail?.cc_address"><span class="font-medium">Cc:</span> <span x-text="selectedEmail?.cc_address"></span></p>
                                </div>

                                <!-- Loading content -->
                                <div x-show="loadingEmailContent" class="flex items-center justify-center py-8">
                                    <div class="spinner w-6 h-6"></div>
                                    <span class="ml-3 text-gray-500">Loading email content...</span>
                                </div>

                                <!-- Email body -->
                                <div x-show="!loadingEmailContent" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                                    <!-- HTML content in sandboxed iframe -->
                                    <iframe
                                        x-show="selectedEmail?.html_content"
                                        :srcdoc="selectedEmail?.html_content || ''"
                                        sandbox="allow-same-origin"
                                        class="w-full border-0"
                                        style="min-height: 300px; max-height: 400px;"
                                    ></iframe>
                                    <!-- Plain text fallback -->
                                    <div
                                        x-show="!selectedEmail?.html_content"
                                        class="p-4 text-gray-600 whitespace-pre-wrap leading-relaxed"
                                        x-text="stripHtml(selectedEmail?.body_full || selectedEmail?.body_snippet || 'No content available')"
                                    ></div>
                                </div>
                            </div>

                            <!-- Reply Section (only for received emails) -->
                            <template x-if="selectedEmail?.direction === 'inbound'">
                                <div class="border-t border-gray-100 p-4">
                                    <template x-if="!showReplyForm">
                                        <button
                                            @click="showReplyForm = true"
                                            class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                                            Reply
                                        </button>
                                    </template>
                                    <template x-if="showReplyForm">
                                        <div class="space-y-3">
                                            <div class="text-sm text-gray-500">
                                                Replying to: <span class="font-medium" x-text="selectedEmail?.from_address"></span>
                                            </div>
                                            <textarea
                                                x-model="replyContent"
                                                placeholder="Type your reply..."
                                                class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                                                rows="4"
                                            ></textarea>
                                            <div class="flex gap-2">
                                                <button
                                                    @click="sendReply()"
                                                    :disabled="!replyContent.trim() || sendingReply"
                                                    :class="!replyContent.trim() || sendingReply ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700'"
                                                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg transition-colors font-medium"
                                                >
                                                    <svg x-show="!sendingReply" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                                    <div x-show="sendingReply" class="spinner w-4 h-4"></div>
                                                    <span x-text="sendingReply ? 'Sending...' : 'Send Reply'"></span>
                                                </button>
                                                <button
                                                    @click="showReplyForm = false; replyContent = ''"
                                                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                            <!-- Success/Error message -->
                                            <div x-show="replyMessage" :class="replySuccess ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'" class="p-3 rounded-lg border text-sm" x-text="replyMessage"></div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Compose Email Modal -->
                <div
                    x-show="composeModalOpen"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0"
                    x-transition:enter-end="opacity-100"
                    x-transition:leave="transition ease-in duration-150"
                    x-transition:leave-start="opacity-100"
                    x-transition:leave-end="opacity-0"
                    class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50"
                    @click="closeComposeModal()"
                >
                    <div
                        x-show="composeModalOpen"
                        x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 scale-95"
                        x-transition:enter-end="opacity-100 scale-100"
                        @click.stop
                        class="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden"
                    >
                        <!-- Modal Header -->
                        <div class="flex items-center justify-between p-4 border-b border-gray-100">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">New Email</p>
                                    <p class="text-sm text-gray-500">To: <span x-text="candidate?.email"></span></p>
                                </div>
                            </div>
                            <button
                                @click="closeComposeModal()"
                                class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                            >
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <!-- Modal Body -->
                        <div class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input
                                    type="text"
                                    x-model="composeSubject"
                                    placeholder="Enter subject..."
                                    class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                                <textarea
                                    x-model="composeContent"
                                    placeholder="Type your message..."
                                    class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                                    rows="6"
                                ></textarea>
                            </div>

                            <!-- Success/Error message -->
                            <div x-show="composeMessage" :class="composeSuccess ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'" class="p-3 rounded-lg border text-sm" x-text="composeMessage"></div>
                        </div>

                        <!-- Modal Footer -->
                        <div class="flex justify-end gap-2 p-4 border-t border-gray-100">
                            <button
                                @click="closeComposeModal()"
                                class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                @click="sendComposedEmail()"
                                :disabled="!composeContent.trim() || sendingCompose"
                                :class="!composeContent.trim() || sendingCompose ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700'"
                                class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg transition-colors font-medium"
                            >
                                <svg x-show="!sendingCompose" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                <div x-show="sendingCompose" class="spinner w-4 h-4"></div>
                                <span x-text="sendingCompose ? 'Sending...' : 'Send Email'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div x-show="activeTab === 'documents'" x-cloak>
                    <div class="text-gray-500 text-center py-12">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-lg font-medium">Document management coming soon</p>
                        <p class="text-sm mt-1">View documents in Zoho CRM for now</p>
                        <a
                            :href="candidate?.zoho_url"
                            target="_blank"
                            class="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-alfa-blue text-white rounded-lg hover:bg-blue-700"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                            Open in Zoho
                        </a>
                    </div>
                </div>

            </div>
        </div>

    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
function candidateDetailApp() {
    return {
        loading: true,
        error: null,
        candidate: null,
        activeTab: 'profile',
        newStage: '',
        newNote: {
            content: '',
            type: 'general'
        },
        // Email state
        emailsLoaded: false,
        emailsLoading: false,
        loadingOlderEmails: false,
        loadingEmailContent: false,
        emailsData: { emails: [], total_count: 0, has_more: false },
        emailThread: { needs_followup: false, days_since_last_response: null },
        selectedEmail: null,
        emailFilter: 'all',  // 'all', 'received', 'sent'
        emailModalOpen: false,
        // Reply state
        showReplyForm: false,
        replyContent: '',
        sendingReply: false,
        replyMessage: '',
        replySuccess: false,
        // Compose state
        composeModalOpen: false,
        composeSubject: '',
        composeContent: '',
        sendingCompose: false,
        composeMessage: '',
        composeSuccess: false,

        async init() {
            // Get candidate ID from URL
            const pathParts = window.location.pathname.split('/');
            const candidateId = pathParts[pathParts.length - 1];

            if (!candidateId || isNaN(candidateId)) {
                this.error = 'Invalid candidate ID';
                this.loading = false;
                return;
            }

            await this.fetchCandidate(candidateId);
            this.loading = false;
        },

        async fetchCandidate(id) {
            try {
                const response = await fetch(`/api/candidates/${id}/detail`);
                if (!response.ok) {
                    if (response.status === 404) {
                        this.error = 'Candidate not found';
                    } else {
                        this.error = 'Failed to load candidate';
                    }
                    return;
                }
                this.candidate = await response.json();
            } catch (err) {
                console.error('Failed to fetch candidate:', err);
                this.error = 'Failed to load candidate';
            }
        },

        async moveStage() {
            if (!this.newStage || this.newStage === this.candidate.stage) return;

            try {
                const response = await fetch(
                    `/api/candidates/${this.candidate.id}/move-stage?new_stage=${encodeURIComponent(this.newStage)}`,
                    { method: 'POST' }
                );

                if (response.ok) {
                    this.candidate.stage = this.newStage;
                    this.candidate.days_in_stage = 0;
                    this.newStage = '';
                }
            } catch (error) {
                console.error('Failed to move stage:', error);
            }
        },

        async addNote() {
            if (!this.newNote.content.trim()) return;

            try {
                const response = await fetch(`/api/candidates/${this.candidate.id}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.newNote.content,
                        note_type: this.newNote.type,
                        created_by: 'User'  // TODO: Get from auth
                    })
                });

                if (response.ok) {
                    const note = await response.json();
                    if (!this.candidate.notes) this.candidate.notes = [];
                    this.candidate.notes.unshift(note);
                    this.newNote.content = '';
                    this.newNote.type = 'general';
                }
            } catch (error) {
                console.error('Failed to add note:', error);
            }
        },

        async deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            try {
                const response = await fetch(`/api/candidates/${this.candidate.id}/notes/${noteId}`, {
                    method: 'DELETE'
                });

                if (response.ok && this.candidate?.notes) {
                    this.candidate.notes = this.candidate.notes.filter(n => n.id !== noteId);
                }
            } catch (error) {
                console.error('Failed to delete note:', error);
            }
        },

        getCrmNotesSummary() {
            // Create a combined summary from all CRM notes
            if (!this.candidate?.crm_notes?.length) return '';

            const notes = this.candidate?.crm_notes || [];
            const maxLength = 300;

            // If only one note, just return its summary
            if (notes.length === 1) {
                return notes[0].summary || notes[0].raw_content;
            }

            // Combine summaries from the most recent notes
            let combined = '';
            for (let i = 0; i < Math.min(3, notes.length); i++) {
                const note = notes[i];
                const summary = note.summary || note.raw_content;
                if (combined.length + summary.length < maxLength) {
                    combined += (combined ? '  ' : '') + summary;
                } else {
                    break;
                }
            }

            // Add count of additional notes if there are more
            const remaining = notes.length - 3;
            if (remaining > 0) {
                combined += ` (+${remaining} more)`;
            }

            return combined || notes[0].summary || notes[0].raw_content;
        },

        getAllKeyPhrases() {
            // Aggregate unique key phrases from all CRM notes
            if (!this.candidate?.crm_notes?.length) return [];

            const allPhrases = new Set();
            for (const note of (this.candidate?.crm_notes || [])) {
                if (note.key_phrases && Array.isArray(note.key_phrases)) {
                    note.key_phrases.forEach(phrase => allPhrases.add(phrase));
                }
            }

            return Array.from(allPhrases);
        },

        getStageBadgeColor(stage) {
            const colors = {
                'New Candidate': 'bg-blue-100 text-blue-700',
                'Screening': 'bg-yellow-100 text-yellow-700',
                'Interview Scheduled': 'bg-orange-100 text-orange-700',
                'Interview Completed': 'bg-purple-100 text-purple-700',
                'Assessment': 'bg-pink-100 text-pink-700',
                'Onboarding': 'bg-indigo-100 text-indigo-700',
                'Active': 'bg-green-100 text-green-700',
                'Inactive': 'bg-gray-100 text-gray-700',
                'Rejected': 'bg-red-100 text-red-700'
            };
            return colors[stage] || 'bg-gray-100 text-gray-700';
        },

        formatDate(dateStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        },

        formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        // Computed property for filtered emails
        get filteredEmails() {
            if (!this.emailsData.emails) return [];
            if (this.emailFilter === 'all') return this.emailsData.emails;
            if (this.emailFilter === 'received') return this.emailsData.emails.filter(e => e.direction === 'inbound');
            if (this.emailFilter === 'sent') return this.emailsData.emails.filter(e => e.direction === 'outbound');
            return this.emailsData.emails;
        },

        // Email methods
        async openEmailModal(email) {
            console.log('Opening email:', email.id, 'Direction:', email.direction);
            this.selectedEmail = email;
            this.emailModalOpen = true;
            this.showReplyForm = false;
            this.replyContent = '';
            this.replyMessage = '';

            // Fetch full content if not already loaded
            if (!email.body_full && !email.html_content) {
                await this.fetchEmailContent(email);
            }
        },

        closeEmailModal() {
            this.emailModalOpen = false;
            this.selectedEmail = null;
            this.showReplyForm = false;
            this.replyContent = '';
            this.replyMessage = '';
        },

        async fetchEmailContent(email) {
            this.loadingEmailContent = true;

            try {
                const response = await fetch(`/api/candidates/${this.candidate.id}/emails/${email.id}/content`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Email content response:', {
                        id: data.id,
                        hasHtmlContent: !!data.html_content,
                        htmlLength: data.html_content?.length,
                        contentLength: data.content?.length
                    });
                    // Update the email in our list with the content
                    const idx = this.emailsData.emails.findIndex(e => e.id === email.id);
                    if (idx !== -1) {
                        this.emailsData.emails[idx].body_full = data.content;
                        this.emailsData.emails[idx].html_content = data.html_content;
                        this.emailsData.emails[idx].body_snippet = data.content?.substring(0, 200) || '';
                    }
                    // Also update selectedEmail - create new object to trigger reactivity
                    if (this.selectedEmail?.id === email.id) {
                        this.selectedEmail = {
                            ...this.selectedEmail,
                            body_full: data.content,
                            html_content: data.html_content
                        };
                        console.log('Updated selectedEmail:', {
                            hasHtmlContent: !!this.selectedEmail.html_content,
                            htmlPreview: this.selectedEmail.html_content?.substring(0, 100)
                        });
                    }
                }
            } catch (err) {
                console.error('Failed to fetch email content:', err);
            } finally {
                this.loadingEmailContent = false;
            }
        },

        async sendReply() {
            if (!this.replyContent.trim() || !this.selectedEmail) return;

            this.sendingReply = true;
            this.replyMessage = '';

            try {
                const response = await fetch('/api/mail/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: [this.selectedEmail.from_address],
                        subject: 'Re: ' + (this.selectedEmail.subject || ''),
                        content: this.replyContent,
                        is_html: false
                    })
                });

                if (response.ok) {
                    this.replySuccess = true;
                    this.replyMessage = 'Reply sent successfully!';
                    this.replyContent = '';
                    // Close form after a short delay
                    setTimeout(() => {
                        this.showReplyForm = false;
                        this.replyMessage = '';
                    }, 2000);
                } else {
                    const error = await response.json();
                    this.replySuccess = false;
                    this.replyMessage = error.detail || 'Failed to send reply';
                }
            } catch (err) {
                console.error('Failed to send reply:', err);
                this.replySuccess = false;
                this.replyMessage = 'Failed to send reply. Please try again.';
            } finally {
                this.sendingReply = false;
            }
        },

        // Compose modal methods
        openComposeModal() {
            this.composeModalOpen = true;
            this.composeSubject = '';
            this.composeContent = '';
            this.composeMessage = '';
            this.composeSuccess = false;
        },

        closeComposeModal() {
            this.composeModalOpen = false;
            this.composeSubject = '';
            this.composeContent = '';
            this.composeMessage = '';
        },

        async sendComposedEmail() {
            if (!this.composeContent.trim()) return;

            this.sendingCompose = true;
            this.composeMessage = '';

            try {
                const response = await fetch('/api/mail/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: [this.candidate.email],
                        subject: this.composeSubject || '(No subject)',
                        content: this.composeContent,
                        is_html: false
                    })
                });

                if (response.ok) {
                    this.composeSuccess = true;
                    this.composeMessage = 'Email sent successfully!';
                    // Close modal after delay
                    setTimeout(() => {
                        this.closeComposeModal();
                        // Refresh emails to show the new sent email
                        this.loadEmails(true);
                    }, 2000);
                } else {
                    const error = await response.json();
                    this.composeSuccess = false;
                    this.composeMessage = error.detail || 'Failed to send email';
                }
            } catch (err) {
                console.error('Failed to send email:', err);
                this.composeSuccess = false;
                this.composeMessage = 'Failed to send email. Please try again.';
            } finally {
                this.sendingCompose = false;
            }
        },

        async loadEmails(includeHistory = false) {
            if (this.emailsLoading) return;

            this.emailsLoading = true;
            this.selectedEmail = null;

            try {
                // Fetch emails from cache
                const url = `/api/candidates/${this.candidate.id}/emails${includeHistory ? '?include_history=true' : ''}`;
                const response = await fetch(url);

                if (response.ok) {
                    this.emailsData = await response.json();
                    this.emailsLoaded = true;

                    // Also fetch thread analysis for AI insights
                    await this.loadEmailThread();
                }
            } catch (err) {
                console.error('Failed to load emails:', err);
            } finally {
                this.emailsLoading = false;
            }
        },

        async loadEmailThread() {
            try {
                const response = await fetch(`/api/candidates/${this.candidate.id}/email-thread`);
                if (response.ok) {
                    this.emailThread = await response.json();
                }
            } catch (err) {
                console.error('Failed to load email thread:', err);
            }
        },

        async loadOlderEmails() {
            if (this.loadingOlderEmails) return;

            this.loadingOlderEmails = true;

            try {
                const response = await fetch(`/api/candidates/${this.candidate.id}/emails?include_history=true`);

                if (response.ok) {
                    const data = await response.json();
                    // Merge with existing emails, avoiding duplicates
                    const existingIds = new Set(this.emailsData.emails.map(e => e.id));
                    const newEmails = data.emails.filter(e => !existingIds.has(e.id));

                    this.emailsData.emails = [...this.emailsData.emails, ...newEmails];
                    this.emailsData.total_count = data.total_count;
                    this.emailsData.has_more = data.has_more;
                    this.emailsData.oldest_cached_date = data.oldest_cached_date;

                    // Re-sort by date (newest first)
                    this.emailsData.emails.sort((a, b) => new Date(b.sent_at) - new Date(a.sent_at));
                }
            } catch (err) {
                console.error('Failed to load older emails:', err);
            } finally {
                this.loadingOlderEmails = false;
            }
        },

        formatEmailDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return date.toLocaleDateString('en-US', { weekday: 'short' });

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },

        formatEmailTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        },

        // Strip HTML tags from text
        stripHtml(html) {
            if (!html) return '';
            // Create a temporary element to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;
            // Get text content which strips all HTML tags
            let text = temp.textContent || temp.innerText || '';
            // Clean up whitespace
            text = text.replace(/\s+/g, ' ').trim();
            return text;
        }
    };
}
</script>
{% endblock %}
