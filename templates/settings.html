{% extends "base.html" %}

{% block title %}Settings - Alfa Operations Platform{% endblock %}

{% block nav_settings %}bg-gray-700{% endblock %}

{% block page_title %}Settings{% endblock %}
{% block page_subtitle %}Platform configuration{% endblock %}

{% block content %}
<div x-data="settingsApp()" x-init="init()">

    <!-- Auto-Sync Section -->
    <div class="bg-white rounded-xl shadow-sm mb-6">
        <div class="p-4 border-b">
            <h2 class="text-lg font-semibold text-gray-800">Auto-Sync from Zoho CRM</h2>
            <p class="text-sm text-gray-500">Automatically sync candidate data at regular intervals</p>
        </div>
        <div class="p-6">
            <!-- Scheduler Status -->
            <div class="flex items-center justify-between mb-6 pb-6 border-b">
                <div class="flex items-center gap-3">
                    <div
                        class="w-3 h-3 rounded-full"
                        :class="scheduler.is_running ? 'bg-green-500 animate-pulse' : 'bg-gray-400'"
                    ></div>
                    <div>
                        <p class="font-medium text-gray-800" x-text="scheduler.is_running ? 'Auto-Sync Active' : 'Auto-Sync Disabled'"></p>
                        <p class="text-sm text-gray-500" x-show="scheduler.is_running">
                            Syncing every <span x-text="scheduler.sync_interval_minutes"></span> minutes
                        </p>
                    </div>
                </div>
                <button
                    @click="toggleScheduler()"
                    :disabled="schedulerLoading"
                    class="px-4 py-2 rounded-lg font-medium transition-colors"
                    :class="scheduler.is_running ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'"
                >
                    <span x-text="scheduler.is_running ? 'Stop Auto-Sync' : 'Start Auto-Sync'"></span>
                </button>
            </div>

            <!-- Sync Interval -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sync Interval</label>
                    <div class="flex gap-2">
                        <select
                            x-model="newInterval"
                            class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-alfa-blue"
                        >
                            <option value="5">Every 5 minutes</option>
                            <option value="10">Every 10 minutes</option>
                            <option value="15">Every 15 minutes</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="60">Every 1 hour</option>
                            <option value="120">Every 2 hours</option>
                            <option value="360">Every 6 hours</option>
                            <option value="720">Every 12 hours</option>
                            <option value="1440">Every 24 hours</option>
                        </select>
                        <button
                            @click="updateInterval()"
                            :disabled="newInterval == scheduler.sync_interval_minutes"
                            class="px-4 py-2 bg-alfa-blue text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                        >
                            Update
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Next Scheduled Sync</label>
                    <p class="px-3 py-2 bg-gray-50 rounded-lg text-gray-700" x-text="formatNextSync(scheduler.next_sync_time)"></p>
                </div>
            </div>

            <!-- Last Sync Info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-medium text-gray-800 mb-3">Last Sync Result</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-gray-800" x-text="scheduler.last_sync_result?.records_processed || 0"></p>
                        <p class="text-xs text-gray-500">Processed</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600" x-text="scheduler.last_sync_result?.records_created || 0"></p>
                        <p class="text-xs text-gray-500">Created</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-blue-600" x-text="scheduler.last_sync_result?.records_updated || 0"></p>
                        <p class="text-xs text-gray-500">Updated</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold" :class="(scheduler.last_sync_result?.errors || 0) > 0 ? 'text-red-600' : 'text-gray-400'" x-text="scheduler.last_sync_result?.errors || 0"></p>
                        <p class="text-xs text-gray-500">Errors</p>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-3 text-center" x-show="scheduler.last_sync_time">
                    Last synced: <span x-text="formatDateTime(scheduler.last_sync_time)"></span>
                </p>
                <p class="text-sm text-gray-400 mt-3 text-center" x-show="!scheduler.last_sync_time">
                    No sync performed yet
                </p>
                <p class="text-sm text-red-600 mt-2 text-center" x-show="scheduler.last_sync_error" x-text="scheduler.last_sync_error"></p>
            </div>

            <!-- Manual Sync -->
            <div class="flex items-center justify-between pt-4 border-t">
                <div>
                    <p class="font-medium text-gray-800">Manual Sync</p>
                    <p class="text-sm text-gray-500">Trigger a sync immediately</p>
                </div>
                <button
                    @click="triggerSync()"
                    :disabled="syncing || scheduler.sync_in_progress"
                    class="px-4 py-2 bg-alfa-blue text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                >
                    <svg x-show="syncing || scheduler.sync_in_progress" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="syncing || scheduler.sync_in_progress ? 'Syncing...' : 'Sync Now'"></span>
                </button>
            </div>

            <div x-show="syncMessage" x-cloak class="mt-4 p-3 rounded-lg" :class="syncSuccess ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'">
                <p x-text="syncMessage"></p>
            </div>
        </div>
    </div>

    <!-- API Status -->
    <div class="bg-white rounded-xl shadow-sm mb-6">
        <div class="p-4 border-b">
            <h2 class="text-lg font-semibold text-gray-800">API Status</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="w-3 h-3 rounded-full mx-auto mb-2" :class="apiStatus.platform ? 'bg-green-500' : 'bg-red-500'"></div>
                    <p class="text-sm font-medium">Platform API</p>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="w-3 h-3 rounded-full mx-auto mb-2" :class="apiStatus.zoho ? 'bg-green-500' : 'bg-yellow-500'"></div>
                    <p class="text-sm font-medium">Zoho CRM</p>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="w-3 h-3 rounded-full mx-auto mb-2 bg-gray-300"></div>
                    <p class="text-sm font-medium">Zoho Books</p>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="w-3 h-3 rounded-full mx-auto mb-2 bg-gray-300"></div>
                    <p class="text-sm font-medium">MS Teams</p>
                </div>
            </div>
        </div>
    </div>

    <!-- About -->
    <div class="bg-white rounded-xl shadow-sm">
        <div class="p-4 border-b">
            <h2 class="text-lg font-semibold text-gray-800">About</h2>
        </div>
        <div class="p-6">
            <div class="space-y-2 text-sm text-gray-600">
                <p><span class="font-medium">Version:</span> 2.0.0</p>
                <p><span class="font-medium">Platform:</span> Alfa Operations Platform</p>
                <p><span class="font-medium">Organization:</span> Alfa Systems</p>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
function settingsApp() {
    return {
        syncing: false,
        syncMessage: '',
        syncSuccess: false,
        schedulerLoading: false,
        newInterval: '30',
        scheduler: {
            is_running: false,
            sync_interval_minutes: 30,
            sync_in_progress: false,
            last_sync_time: null,
            last_sync_result: null,
            last_sync_error: null,
            next_sync_time: null
        },
        apiStatus: {
            platform: true,
            zoho: false
        },

        async init() {
            await this.fetchSchedulerStatus();
            await this.checkApiStatus();
            // Refresh status every 30 seconds
            setInterval(() => this.fetchSchedulerStatus(), 30000);
        },

        async fetchSchedulerStatus() {
            try {
                const response = await fetch('/api/sync/scheduler/status');
                if (response.ok) {
                    this.scheduler = await response.json();
                    this.newInterval = String(this.scheduler.sync_interval_minutes);
                }
            } catch (error) {
                console.error('Failed to fetch scheduler status:', error);
            }
        },

        async toggleScheduler() {
            this.schedulerLoading = true;
            try {
                const endpoint = this.scheduler.is_running ? '/api/sync/scheduler/stop' : '/api/sync/scheduler/start';
                const response = await fetch(endpoint, { method: 'POST' });
                if (response.ok) {
                    await this.fetchSchedulerStatus();
                }
            } catch (error) {
                console.error('Failed to toggle scheduler:', error);
            }
            this.schedulerLoading = false;
        },

        async updateInterval() {
            try {
                const response = await fetch(`/api/sync/scheduler/interval?interval_minutes=${this.newInterval}`, {
                    method: 'PUT'
                });
                if (response.ok) {
                    await this.fetchSchedulerStatus();
                }
            } catch (error) {
                console.error('Failed to update interval:', error);
            }
        },

        async triggerSync() {
            this.syncing = true;
            this.syncMessage = '';

            try {
                const response = await fetch('/api/sync/scheduler/trigger', { method: 'POST' });
                const data = await response.json();

                if (data.error) {
                    this.syncSuccess = false;
                    this.syncMessage = data.error;
                } else {
                    this.syncSuccess = true;
                    this.syncMessage = `Sync complete! ${data.records_processed || 0} records processed.`;
                    await this.fetchSchedulerStatus();
                }
            } catch (error) {
                this.syncSuccess = false;
                this.syncMessage = 'Failed to connect to server';
            }

            this.syncing = false;
        },

        async checkApiStatus() {
            try {
                const response = await fetch('/health');
                this.apiStatus.platform = response.ok;
            } catch {
                this.apiStatus.platform = false;
            }
        },

        formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        formatNextSync(dateStr) {
            if (!dateStr) return 'Not scheduled';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = date - now;
            const diffMins = Math.round(diffMs / 60000);

            if (diffMins <= 0) return 'Any moment now...';
            if (diffMins === 1) return 'In 1 minute';
            if (diffMins < 60) return `In ${diffMins} minutes`;

            const diffHours = Math.floor(diffMins / 60);
            const remainingMins = diffMins % 60;
            if (diffHours === 1) return `In 1 hour ${remainingMins > 0 ? remainingMins + ' min' : ''}`;
            return `In ${diffHours} hours ${remainingMins > 0 ? remainingMins + ' min' : ''}`;
        }
    };
}
</script>
{% endblock %}
